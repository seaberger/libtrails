---
import type { ThemeSummary } from '../lib/types';
import BookCover from './BookCover.astro';
import { url } from '../lib/url';

interface Props {
  theme: ThemeSummary;
}

const { theme } = Astro.props;

// Get up to 5 books for the cover stack
const stackBooks = theme.sample_books.slice(0, 5);
const bookCount = stackBooks.length;
---

<a
  href={url(`/clusters/${theme.cluster_id}`)}
  class="group relative block overflow-visible bg-[var(--color-surface)] rounded-lg p-5 border border-[var(--color-border)] hover:border-[var(--color-accent)] hover:shadow-lg hover:z-10 transition-all duration-300"
  data-theme-card
>
  <!-- Cover stack with fan-out on hover -->
  <div class="relative h-40 mb-4 flex items-center justify-center">
    <div class="relative" style="width: 180px; height: 140px;">
      {stackBooks.map((book, index) => {
        // Calculate positions
        const center = (bookCount - 1) / 2;
        const offset = index - center;

        // Stacked (default): tight stack
        const stackedX = offset * 8;
        const stackedRotate = offset * 1.5;

        // Fanned (hover): poker-hand arc via rotation around distant pivot
        const fannedX = offset * 16;
        const fannedRotate = offset * 16;

        return (
          <div
            class="absolute left-1/2 transition-all duration-300 ease-out group-hover:scale-105"
            style={`
              z-index: ${bookCount - index};
              transform: translateX(calc(-50% + ${stackedX}px)) rotate(${stackedRotate}deg);
              transform-origin: center 150%;
            `}
            data-fanned-x={fannedX}
            data-fanned-rotate={fannedRotate}
            data-stacked-x={stackedX}
            data-stacked-rotate={stackedRotate}
          >
            <BookCover
              calibreId={book.calibre_id}
              title={book.title}
              size="md"
            />
          </div>
        );
      })}
    </div>
  </div>

  <!-- Theme info -->
  <h3 class="font-bold text-[var(--color-text)] text-base leading-tight mb-2 text-center capitalize">
    {theme.label}
  </h3>
  <p class="text-xs text-[var(--color-text-muted)] text-center">
    {theme.book_count} books Â· {theme.size} topics
  </p>
</a>

<script>
  // Fan out cards on hover - only on homepage with theme cards
  function initFanEffect() {
    const cards = document.querySelectorAll('[data-theme-card]');
    if (!cards.length) return;

    cards.forEach(card => {
      const books = card.querySelectorAll('[data-fanned-x]');
      if (!books.length) return;

      card.addEventListener('mouseenter', () => {
        books.forEach(book => {
          const x = book.getAttribute('data-fanned-x');
          const rotate = book.getAttribute('data-fanned-rotate');
          (book as HTMLElement).style.transform = `translateX(calc(-50% + ${x}px)) rotate(${rotate}deg)`;
        });
      });

      card.addEventListener('mouseleave', () => {
        books.forEach(book => {
          const x = book.getAttribute('data-stacked-x');
          const rotate = book.getAttribute('data-stacked-rotate');
          (book as HTMLElement).style.transform = `translateX(calc(-50% + ${x}px)) rotate(${rotate}deg)`;
        });
      });
    });
  }

  // Run immediately (Astro scripts are deferred, so DOM is ready)
  initFanEffect();
  // Also re-run after Astro view transitions if enabled
  document.addEventListener('astro:page-load', initFanEffect);
</script>
