---
// Server-rendered dynamic route
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import BookCover from '../../components/BookCover.astro';
import TopicChip from '../../components/TopicChip.astro';
import RelatedBooks from '../../components/RelatedBooks.astro';
import { getBook, getRelatedBooks } from '../../lib/api';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/books');
}

const bookId = parseInt(id, 10);

let book;
let relatedBooks = [];

try {
  book = await getBook(bookId);
  relatedBooks = await getRelatedBooks(bookId, 12);
} catch (e) {
  return Astro.redirect('/books');
}
---

<BaseLayout title={book.title} description={book.description || `Details for ${book.title} by ${book.author}`}>
  <nav class="text-sm text-[var(--color-text-muted)] mb-6">
    <a href="/books" class="hover:text-[var(--color-text)] transition-colors">All Books</a>
    <span class="mx-2">/</span>
    <span class="text-[var(--color-text)]">{book.title}</span>
  </nav>

  <div class="flex flex-col md:flex-row gap-8">
    <!-- Cover -->
    <div class="flex-shrink-0 self-start">
      <div class="book-cover">
        <BookCover
          calibreId={book.calibre_id}
          title={book.title}
          size="lg"
        />
      </div>
    </div>

    <!-- Book details -->
    <div class="flex-1">
      <h1 class="text-2xl font-medium text-[var(--color-text)] mb-2">
        {book.title}
      </h1>
      <p class="text-lg text-[var(--color-text-muted)] mb-4">
        {book.author}
      </p>

      {book.description && (
        <div class="prose prose-sm max-w-none text-[var(--color-text)] mb-6">
          <p>{book.description}</p>
        </div>
      )}

      <!-- Stats -->
      <div class="flex gap-4 text-sm text-[var(--color-text-muted)] mb-6">
        <span>{book.chunk_count} chunks indexed</span>
        <span>·</span>
        <span>{book.topics.length} topics</span>
        <span>·</span>
        <span>{book.theme_ids.length} themes</span>
      </div>

      <!-- Topics -->
      {book.topics.length > 0 && (
        <div class="mb-6">
          <h2 class="text-sm font-medium text-[var(--color-text)] mb-3">Topics</h2>
          <div class="flex flex-wrap gap-2">
            {book.topics.map(topic => (
              <TopicChip
                label={topic.label}
                count={topic.count}
                href={topic.cluster_id !== null ? `/themes/${topic.cluster_id}` : undefined}
              />
            ))}
          </div>
        </div>
      )}

      <!-- Theme links -->
      {book.theme_ids.length > 0 && (
        <div class="mb-6">
          <h2 class="text-sm font-medium text-[var(--color-text)] mb-3">Found in Themes</h2>
          <div class="flex flex-wrap gap-2">
            {book.theme_ids.slice(0, 8).map(themeId => (
              <a
                href={`/themes/${themeId}`}
                class="inline-flex items-center gap-1 px-3 py-1 text-sm bg-[var(--color-bg)] border border-[var(--color-border)] rounded-md text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:border-[var(--color-accent)] transition-colors"
              >
                Theme #{themeId}
              </a>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>

  <!-- Related books -->
  <RelatedBooks books={relatedBooks} />
</BaseLayout>
